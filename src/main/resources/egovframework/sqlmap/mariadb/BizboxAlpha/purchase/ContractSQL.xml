<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ContractSQL">
	
	<select	id="ContractSQL.SelectContractSeqFromManageNo" parameterClass="HashMap" resultClass="int">
		
		SELECT 
		seq
		FROM cust_sto.t_purchase_contract
		where manage_no = '$manage_no$'
		
	</select>
		
	<select	id="ContractSQL.SelectContractList" parameterClass="HashMap" resultClass="HashMap">
		
		SELECT 
		a.seq, 
		a.manage_no, 
		a.contract_no,
		a.contract_type,
		a.write_comp_seq, 
		a.write_dept_seq, 
		a.write_emp_seq, 
		a.write_dt, 
		a.c_write_comp_seq, 
		a.c_write_dept_seq, 
		a.c_write_emp_seq, 
		a.c_write_dt, 		
		a.noti_type, 
		a.budget_type, 
		a.target_type, cd_target_type.NAME as target_type_name,
		a.title, 
		a.contract_start_dt, 
		a.contract_end_dt, 
		FORMAT(a.amt, 0) as amt,
		a.amt_kor,
		FORMAT(a.std_amt, 0) as std_amt,
		FORMAT(a.tax_amt, 0) as tax_amt,		
		a.base_law, cd_base_law.NAME as base_law_name,
		a.pay_type_info, 
		a.work_info, 
		a.emergency_yn, 
		a.restrict_sector_yn, 
		a.compete_type, 
		a.restrict_sector_info, 
		a.restrict_area_info, 
		a.nominee_info, 
		a.decision_type_info, 
		a.contract_form1, 
		a.contract_form2, 
		a.contract_form3, 
		a.rebid_yn, 
		a.eorder_use_yn, 
		a.created_dt, 
		a.created_by, 
		a.modify_dt, 
		a.modify_by,
		
		ifnull(a.doc_sts,'') as doc_sts, 
		ifnull(a.approkey_plan,'') as approkey_plan, 
		ifnull(a.approkey_meet,'') as approkey_meet, 
		ifnull(a.approkey_result,'') as approkey_result,
		ifnull(a.approkey_conclusion,'') as approkey_conclusion,
		ifnull(a.approkey_change,'') as approkey_change				
		
		FROM cust_sto.t_purchase_contract a
		join cust_sto.t_purchase_code_detail cd_target_type on cd_target_type.`GROUP` ='targetType' and a.target_type =cd_target_type.code
		join cust_sto.t_purchase_code_detail cd_base_law on cd_base_law.`GROUP` ='baseLaw' and a.base_law  =cd_base_law.code
		order by a.seq desc
		
	</select>	
	
	<select	id="ContractSQL.SelectContractDetail" parameterClass="HashMap" resultClass="HashMap">
		
		SELECT 
		a.seq, 
		a.manage_no, 
		a.contract_no,
		a.contract_type,
		a.write_comp_seq, 
		a.write_dept_seq, dm.dept_name as write_dept_name, 
		a.write_emp_seq, em.emp_name as write_emp_name, 
		a.write_dt,
		a.c_write_comp_seq, 
		a.c_write_dept_seq, cdm.dept_name as c_write_dept_name, 
		a.c_write_emp_seq, cem.emp_name as c_write_emp_name, 
		a.c_write_dt,		
		a.noti_type, 
		a.budget_type, a.c_budget_type, 
		a.target_type, a.c_target_type, 
		a.title,
		a.c_title, 
		a.contract_start_dt, 
		a.contract_end_dt, 
		a.c_contract_end_dt, 
		FORMAT(a.amt, 0) as amt,
		a.amt_kor,
		FORMAT(a.std_amt, 0) as std_amt,
		FORMAT(a.tax_amt, 0) as tax_amt,
		a.base_law, 
		a.c_base_law, 
		a.pay_type_info, 
		a.work_info, a.c_work_info, 
		a.emergency_yn, 
		a.restrict_sector_yn, 
		a.compete_type, 
		a.restrict_sector_info, 
		a.restrict_area_info, 
		a.nominee_info, 
		a.decision_type_info, 
		a.contract_form1, 
		a.contract_form2, 
		a.contract_form3, 
		a.rebid_yn, 
		a.eorder_use_yn, 
		a.created_dt, 
		a.created_by, 
		a.modify_dt, 
		a.modify_by,
		
		ifnull(a.doc_sts,'') as doc_sts, 
		ifnull(a.approkey_plan,'') as approkey_plan, 
		ifnull(a.approkey_meet,'') as approkey_meet, 
		ifnull(a.approkey_result,'') as approkey_result,
		ifnull(a.approkey_conclusion,'') as approkey_conclusion,
		ifnull(a.approkey_change,'') as approkey_change,
		ifnull(pcc.change_seq,'') as change_seq,
		
		ifnull(a.meet_dt,'') as meet_dt, 
		ifnull(a.meet_place,'') as meet_place,
		ifnull(a.meet_method_pt,'') as meet_method_pt,
		ifnull(a.meet_method_qa,'') as meet_method_qa,
		FORMAT(a.meet_amt_spent, 0) as meet_amt_spent,
		
		ifnull(a.result_judges_info,'') as result_judges_info, 
		ifnull(a.result_score_info,'') as result_score_info, 		
		ifnull(a.result_target_info,'') as result_target_info, 
		FORMAT(a.result_amt, 0) as result_amt,
		
		a.contract_term,
		a.hope_attach_info,
		a.hope_company_info,
		a.partner_addr,
		a.partner_bizno,
		a.partner_code,
		a.partner_name,
		a.partner_owner,
		a.private_reason,
		a.pm_email,
		a.pm_hp,
		a.pm_name,
		FORMAT(a.contract_amt, 0) as contract_amt,
		ifnull(a.contract_amt_info,'') as contract_amt_info
		
		FROM cust_sto.t_purchase_contract a
		left join cust_sto.t_purchase_conclusion_change pcc on a.seq = pcc.seq and ifnull(pcc.doc_sts,'') != '90'
		left join $DB_NEOS$t_co_dept_multi dm on a.write_dept_seq = dm.dept_seq and dm.lang_code = 'kr'
		left join $DB_NEOS$t_co_emp_multi em on a.write_emp_seq = em.emp_seq and em.lang_code = 'kr'
		left join $DB_NEOS$t_co_dept_multi cdm on a.c_write_dept_seq = cdm.dept_seq and cdm.lang_code = 'kr'
		left join $DB_NEOS$t_co_emp_multi cem on a.c_write_emp_seq = cem.emp_seq and cem.lang_code = 'kr'
		
		where a.seq = $seq$
		limit 1;
	</select>	
	
	<select	id="ContractSQL.SelectConclusionChangeDetail" parameterClass="HashMap" resultClass="HashMap">
	
		SELECT 
		a.change_seq, 
		a.seq, 
		a.change_item_info, 
		a.work_info_before, 
		a.work_info_after, 
		a.contract_end_dt_before, 
		a.contract_end_dt_after, 
		a.contract_amt_info_before, 
		a.contract_amt_info_after, 
		ifnull(a.doc_sts,'') as doc_sts, 
		ifnull(a.approkey_change,'') as approkey_change,
		a.change_etc,
		a.change_reason,		
		a.created_dt, 
		a.created_by, 
		a.modify_dt, 
		a.modify_by
		
		FROM cust_sto.t_purchase_conclusion_change a
		WHERE a.change_seq=$change_seq$;

	</select>	
	
	
	<insert	id="ContractSQL.InsertContract" parameterClass="HashMap" >
		
		<selectKey keyProperty="manage_no" resultClass="java.lang.String">
		select concat('$budget_type$', '-', YEAR(now()), '-', LPAD( ifnull( (select max(substr(manage_no, 9)) from cust_sto.t_purchase_contract where manage_no like concat('$budget_type$-',YEAR(now()),'-%')) , '0') + 1 , 4, '0')) as manage_no from dual		
	    </selectKey>		
		
		INSERT INTO cust_sto.t_purchase_contract
		(
		manage_no, 
		contract_no,
		contract_type,
		write_comp_seq, 
		write_dept_seq, 
		write_emp_seq, 
		write_dt,
		noti_type, 
		budget_type, 
		target_type, 
		title, 
		contract_start_dt, 
		contract_end_dt, 
		amt, 
		amt_kor,
		std_amt, 
		tax_amt, 
		base_law, 
		pay_type_info, 
		work_info, 
		emergency_yn, 
		restrict_sector_yn, 
		compete_type, 
		restrict_sector_info, 
		restrict_area_info, 
		nominee_info, 
		decision_type_info, 
		contract_form1, 
		contract_form2, 
		contract_form3, 
		rebid_yn, 
		eorder_use_yn, 
		created_dt, 
		created_by, 
		modify_dt, 
		modify_by
		
		)
		VALUES(
		'$manage_no$', 
		'$contract_no$',
		'$contract_type$',
		'$write_comp_seq$', 
		'$write_dept_seq$', 
		'$write_emp_seq$', 
		'$write_dt$',
		'$noti_type$', 
		'$budget_type$', 
		'$target_type$', 
		'$title$', 
		'$contract_start_dt$', 
		'$contract_end_dt$', 
		'$amt$',
		'$amt_kor$', 
		'$std_amt$', 
		'$tax_amt$', 
		'$base_law$', 
		'$pay_type_info$', 
		'$work_info$', 
		'$emergency_yn$', 
		'$restrict_sector_yn$', 
		'$compete_type$', 
		'$restrict_sector_info$', 
		'$restrict_area_info$', 
		'$nominee_info$', 
		'$decision_type_info$', 
		'$contract_form1$', 
		'$contract_form2$', 
		'$contract_form3$', 
		'$rebid_yn$', 
		'$eorder_use_yn$', 
		now(), 
		'$created_by$', 
		null, 
		null
		);

	</insert>	
	
	
	<insert	id="ContractSQL.InsertConclusion" parameterClass="HashMap" >
		
		<selectKey keyProperty="manage_no" resultClass="java.lang.String">
		select concat('$c_target_type$', '-', YEAR(now()), '-', LPAD( ifnull( (select max(substr(manage_no, 9)) from cust_sto.t_purchase_contract where manage_no like concat('$c_target_type$-',YEAR(now()),'-%')) , '0') + 1 , 4, '0')) as manage_no from dual		
	    </selectKey>		
		
		INSERT INTO cust_sto.t_purchase_contract
		(
		manage_no, 
		contract_no,
		contract_type,
		c_write_comp_seq, 
		c_write_dept_seq, 
		c_write_emp_seq, 
		c_write_dt,		 
		c_budget_type, 
		c_target_type, 
		c_title, 
		c_contract_end_dt, 
		c_base_law, 
		c_work_info,

		contract_term,
		hope_attach_info,
		hope_company_info,
		partner_addr,
		partner_bizno,
		partner_code,
		partner_name,
		partner_owner,
		private_reason,
		pm_email,
		pm_hp,
		pm_name,
		contract_amt,
		contract_amt_info,		
		 
		created_dt, 
		created_by, 
		modify_dt, 
		modify_by
		
		)
		VALUES(
		'$manage_no$', 
		'$contract_no$',
		'$contract_type$',
		'$c_write_comp_seq$', 
		'$c_write_dept_seq$', 
		'$c_write_emp_seq$', 
		'$c_write_dt$',		 
		'$c_budget_type$', 
		'$c_target_type$', 
		'$c_title$', 
		'$c_contract_end_dt$', 
		'$c_base_law$', 
		'$c_work_info$', 
		
		'$contract_term$',
		'$hope_attach_info$',
		'$hope_company_info$',
		'$partner_addr$',
		'$partner_bizno$',
		'$partner_code$',
		'$partner_name$',
		'$partner_owner$',
		'$private_reason$',
		'$pm_email$',
		'$pm_hp$',
		'$pm_name$',
		0,
		'$contract_amt_info$',		
		
		now(), 
		'$created_by$', 
		null, 
		null
		);

	</insert>
	
	
	<insert	id="ContractSQL.InsertConclusionChange" parameterClass="HashMap" >
	
		INSERT INTO cust_sto.t_purchase_conclusion_change
		(
		seq, 
		change_item_info, 
		work_info_before, 
		work_info_after, 
		contract_end_dt_before, 
		contract_end_dt_after, 
		contract_amt_info_before, 
		contract_amt_info_after, 
		change_etc, 
		change_reason, 
		created_dt, 
		created_by 
		)
		VALUES(
		'$seq$', 
		'$change_item_info$', 
		'$work_info_before$', 
		'$work_info_after$',  
		'$contract_end_dt_before$',  
		'$contract_end_dt_after$',  
		'$contract_amt_info_before$',  
		'$contract_amt_info_after$',  
		'$change_etc$',  
		'$change_reason$',  		
		now(),  
		'$created_by$'  
		);
		
		<selectKey keyProperty="change_seq" resultClass="int">
			SELECT LAST_INSERT_ID();
		</selectKey>		

	</insert>	
			
	
	<update	id="ContractSQL.UpdateContract" parameterClass="HashMap" >
		UPDATE cust_sto.t_purchase_contract
		SET
		write_comp_seq='$write_comp_seq$', 
		write_dept_seq='$write_dept_seq$', 
		write_emp_seq='$write_emp_seq$', 
		write_dt='$write_dt$', 
		noti_type='$noti_type$', 
		budget_type='$budget_type$', 
		target_type='$target_type$', 
		title='$title$', 
		contract_start_dt='$contract_start_dt$', 
		contract_end_dt='$contract_end_dt$', 
		amt='$amt$', 
		amt_kor='$amt_kor$', 
		std_amt='$std_amt$', 
		tax_amt='$tax_amt$', 
		base_law='$base_law$', 
		pay_type_info='$pay_type_info$', 
		work_info='$work_info$', 
		emergency_yn='$emergency_yn$', 
		restrict_sector_yn='$restrict_sector_yn$', 
		compete_type='$compete_type$', 
		restrict_sector_info='$restrict_sector_info$', 
		restrict_area_info='$restrict_area_info$', 
		nominee_info='$nominee_info$', 
		decision_type_info='$decision_type_info$', 
		contract_form1='$contract_form1$', 
		contract_form2='$contract_form2$', 
		contract_form3='$contract_form3$', 
		rebid_yn='$rebid_yn$', 
		eorder_use_yn='$eorder_use_yn$', 
		modify_dt=now(), 
		modify_by='$created_by$'
		
		WHERE seq='$seq$'; 
	</update>	
	
	<update	id="ContractSQL.UpdateConclusion" parameterClass="HashMap" >
		UPDATE cust_sto.t_purchase_contract
		SET

		c_write_comp_seq='$c_write_comp_seq$', 
		c_write_dept_seq='$c_write_dept_seq$', 
		c_write_emp_seq='$c_write_emp_seq$', 
		c_write_dt='$c_write_dt$',		 
		c_budget_type='$c_budget_type$', 
		c_target_type='$c_target_type$', 
		c_title='$c_title$', 
		c_contract_end_dt='$c_contract_end_dt$', 
		c_base_law='$c_base_law$', 
		c_work_info='$c_work_info$', 
		
		contract_term='$contract_term$',
		hope_attach_info='$hope_attach_info$',
		hope_company_info='$hope_company_info$',
		partner_addr='$partner_addr$',
		partner_bizno='$partner_bizno$',
		partner_code='$partner_code$',
		partner_name='$partner_name$',
		partner_owner='$partner_owner$',
		private_reason='$private_reason$',
		pm_email='$pm_email$',
		pm_hp='$pm_hp$',
		pm_name='$pm_name$',
		contract_amt=0,
		contract_amt_info='$contract_amt_info$',			
		
		modify_dt=now(), 
		modify_by='$created_by$'
		
		WHERE seq='$seq$'; 
	</update>	
	
	<update	id="ContractSQL.UpdateConclusionChange" parameterClass="HashMap" >
		UPDATE cust_sto.t_purchase_conclusion_change
		SET
		change_item_info = '$change_item_info$',
		work_info_before = '$work_info_before$', 
		work_info_after = '$work_info_after$',
		contract_end_dt_before = '$contract_end_dt_before$',  
		contract_end_dt_after = '$contract_end_dt_after$',
		contract_amt_info_before = '$contract_amt_info_before$',   
		contract_amt_info_after = '$contract_amt_info_after$',  
		change_etc = '$change_etc$',   
		change_reason = '$change_reason$',   
		modify_dt=now(), 
		modify_by='$created_by$'

		WHERE change_seq='$change_seq$'; 
	</update>		
	
	<update	id="ContractSQL.UpdateMeet" parameterClass="HashMap" >
		UPDATE cust_sto.t_purchase_contract
		SET
		meet_dt='$meet_dt$', 
		meet_place='$meet_place$', 
		meet_method_pt='$meet_method_pt$', 
		meet_method_qa='$meet_method_qa$', 
		meet_amt_spent='$meet_amt_spent$', 
		modify_dt=now(), 
		modify_by='$created_by$'
		
		WHERE seq='$seq$'; 
	</update>
	
	<update	id="ContractSQL.UpdateResult" parameterClass="HashMap" >
		UPDATE cust_sto.t_purchase_contract
		SET
		
		<isNotEmpty property="nominee_info">
		nominee_info='$nominee_info$', 
		</isNotEmpty>			
		
		result_judges_info='$result_judges_info$', 
		result_score_info='$result_score_info$', 
		result_target_info='$result_target_info$', 
		result_amt='$result_amt$', 
		modify_dt=now(), 
		modify_by='$created_by$'

		WHERE seq='$seq$'; 
	</update>		
		
</sqlMap>